<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Support IDE</title>
  <style>
    :root {
      /* Themeable Colors */
      --bg-nav: #252526;
      --bg-sidebar: #252526;
      --bg-content: #1e1e1e;
      --bg-notes: #1e1e1e;
      --accent: #E91E63;
      --text-main: #e0e0e0;
      --text-header: #ffffff;
      
      /* Static Colors */
      --border: #3e3e42;
      --status-ongoing: #007acc;
      --status-pending: #d19a66;
      --status-done: #6a9955;
      --tab-inactive: rgba(0,0,0,0.2);
      --tab-active: var(--bg-content);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-content);
      color: var(--text-main);
      height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
      transition: color 0.2s, background 0.2s;
    }

    /* --- UI COMPONENTS --- */
    #notification-toast {
      position: fixed; top: 20px; right: 20px;
      background: var(--status-done); color: white;
      padding: 10px 20px; border-radius: 4px;
      font-weight: 600; font-size: 13px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999; opacity: 0; pointer-events: none;
      transform: translateY(-10px); transition: all 0.2s ease;
    }
    #notification-toast.show { opacity: 1; transform: translateY(0); }

    /* Top Bar */
    #top-bar {
      height: 35px; background: var(--bg-nav);
      display: flex; align-items: flex-end;
      padding-left: 0; border-bottom: 1px solid var(--border);
      user-select: none; padding-right: 15px;
    }

    .tab {
      height: 35px; padding: 0 15px; display: flex; align-items: center;
      gap: 8px; background: var(--tab-inactive); color: #888;
      font-size: 12px; cursor: pointer; border-right: 1px solid var(--border);
      min-width: 120px; max-width: 200px; position: relative;
    }
    .tab.active {
      background: var(--tab-active); color: var(--text-header);
      border-top: 2px solid var(--accent);
      border-bottom: 1px solid var(--bg-content); margin-bottom: -1px;
    }
    .tab.status-ongoing.active { border-top-color: var(--status-ongoing); }
    .tab.status-pending.active { border-top-color: var(--status-pending); }
    .tab.status-done.active    { border-top-color: var(--status-done); }

    .tab-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
    .tab.status-ongoing .tab-status-dot { background: var(--status-ongoing); }
    .tab.status-pending .tab-status-dot { background: var(--status-pending); }
    .tab.status-done .tab-status-dot    { background: var(--status-done); }

    .tab-close { margin-left: auto; font-size: 14px; padding: 2px 4px; border-radius: 2px; }
    .tab-close:hover { background: #444; color: #fff; }

    #new-tab-btn {
      height: 35px; width: 35px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #aaa; font-size: 18px;
    }
    #new-tab-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }

    /* Right Controls (Lang + Info) */
    .top-right-controls {
      margin-left: auto; display: flex; align-items: center; gap: 10px; height: 100%;
    }

    #lang-select {
      background: rgba(0,0,0,0.3); border: 1px solid var(--border);
      color: #ccc; font-size: 11px; border-radius: 4px; padding: 2px 5px;
      outline: none; cursor: pointer; height: 24px; margin-bottom: 5px;
    }
    #lang-select:hover { border-color: var(--accent); color: #fff; }

    #info-btn {
      width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #888; border-radius: 4px;
      font-size: 14px; margin-bottom: 5px;
    }
    #info-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

    /* Search */
    #command-palette {
      height: 40px; display: flex; align-items: center; padding: 0 10px;
      border-bottom: 1px solid var(--border); background: var(--bg-content);
    }
    #search-box {
      width: 100%; background: rgba(255,255,255,0.05);
      border: 1px solid var(--border); color: var(--text-main);
      padding: 6px 10px; font-size: 13px; border-radius: 2px; outline: none;
    }
    #search-box:focus { border-color: var(--accent); }

    /* Layout */
    #workspace { display: flex; flex: 1; overflow: hidden; position: relative; }

    #sidebar {
      width: 300px; background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; flex-shrink: 0;
    }

    .sidebar-section { padding: 15px; overflow-y: auto; flex: 1; }
    .control-group { margin-bottom: 12px; }
    .control-group label {
      display: block; font-size: 11px; text-transform: uppercase;
      color: var(--text-main); opacity: 0.7; margin-bottom: 4px; font-weight: 600;
    }
    .input-std {
      width: 100%; background: rgba(0,0,0,0.3);
      border: 1px solid var(--border); color: var(--text-main);
      padding: 6px 8px; font-size: 12px; outline: none;
    }
    .input-std:focus { border-color: var(--accent); }

    .sidebar-footer {
      padding: 10px; background: rgba(0,0,0,0.2);
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    }
    .full-span { grid-column: span 2; }

    .btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border); color: var(--text-main);
      padding: 8px 10px; font-size: 11px; cursor: pointer;
      text-align: center; text-transform: uppercase;
      font-weight: 600; transition: background 0.1s;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .btn:hover { background: rgba(255,255,255,0.1); color: var(--text-header); }
    .btn.primary { background: var(--accent); color: white; border-color: var(--accent); }

    #content-area {
      flex: 1; padding: 20px; overflow-y: auto;
      background: var(--bg-content); padding-bottom: 200px;
    }

    .category-header {
      font-size: 13px; font-weight: bold; color: var(--accent);
      border-bottom: 1px solid var(--border); padding-bottom: 5px;
      margin-top: 20px; margin-bottom: 10px; text-transform: uppercase;
    }
    .category-header:first-child { margin-top: 0; }

    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
    }

    .card {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      padding: 10px; cursor: pointer;
      font-family: 'Consolas', monospace; font-size: 12px;
      color: var(--text-main); transition: all 0.1s;
    }
    .card:hover { background: rgba(255,255,255,0.08); border-color: #666; }
    .card:active { border-color: var(--accent); transform: translateY(1px); }
    .card strong { color: var(--accent); display: block; margin-bottom: 5px; opacity: 0.9; }
    .highlight-var { color: var(--text-header); font-weight: bold; background: rgba(255,255,255,0.1); padding: 0 2px; }

    /* Drawer */
    #notes-drawer {
      position: absolute; bottom: 0; left: 300px; right: 0;
      background: var(--bg-notes); border-top: 1px solid var(--accent); z-index: 100;
      transition: height 0.2s ease; height: 150px; display: flex; flex-direction: column;
    }
    #notes-drawer.minimized { height: 30px; }
    #notes-drawer.maximized { height: 90%; border-top: 4px solid var(--accent); }

    .drawer-header {
      height: 30px; background: rgba(0,0,0,0.2); padding: 0 15px;
      display: flex; align-items: center; justify-content: space-between;
      font-size: 11px; text-transform: uppercase; color: var(--text-main);
      cursor: row-resize; user-select: none;
    }
    .drawer-controls span { margin-left: 10px; cursor: pointer; padding: 2px 6px; }
    .drawer-controls span:hover { color: var(--text-header); background: #444; }

    #note-input {
      flex: 1; width: 100%; background: transparent; border: none;
      color: var(--text-main); padding: 15px; resize: none;
      font-family: 'Consolas', monospace; font-size: 13px; outline: none;
    }

    /* Overlay */
    #about-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
      z-index: 99999; display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    #about-overlay.open { opacity: 1; pointer-events: all; }
    .about-card {
      background: var(--bg-sidebar); border: 1px solid var(--border);
      width: 400px; max-width: 90%; padding: 30px;
      border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      text-align: center;
    }
    .about-card h2 { margin-top: 0; color: var(--accent); }
    .about-card p { font-size: 14px; color: var(--text-main); line-height: 1.6; margin-bottom: 25px; }
    .social-btns { display: flex; gap: 10px; justify-content: center; }
    .social-btn {
      text-decoration: none; padding: 10px 20px; border-radius: 4px;
      font-weight: 600; font-size: 13px; color: white; transition: transform 0.1s;
    }
    .social-btn:hover { transform: translateY(-2px); }
    .btn-gh { background: #333; }
    .btn-li { background: #0077b5; }
    .close-overlay { margin-top: 20px; cursor: pointer; color: #888; font-size: 12px; text-decoration: underline; }

    #jsonUpload { display: none; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #424242; }
    ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }
  </style>
</head>
<body>

  <div id="notification-toast">üìã Copied!</div>

  <div id="about-overlay">
    <div class="about-card">
      <h2>Support IDE</h2>
      <p>A high-efficiency, multi-session customer support console designed to streamline snippet management and workflow tracking.</p>
      <div class="social-btns">
        <a href="https://github.com" target="_blank" class="social-btn btn-gh">GitHub</a>
        <a href="https://linkedin.com" target="_blank" class="social-btn btn-li">LinkedIn</a>
      </div>
      <div class="close-overlay" onclick="toggleAbout()">Close</div>
    </div>
  </div>

  <div id="top-bar">
    <div id="tabs-container" style="display:flex;"></div>
    <div id="new-tab-btn" title="New Ticket">+</div>
    
    <div class="top-right-controls">
      <select id="lang-select">
        <option value="en">EN</option>
      </select>
      <div id="info-btn" onclick="toggleAbout()">‚ìò</div>
    </div>
  </div>

  <div id="command-palette">
    <input type="text" id="search-box" placeholder="Search..." />
  </div>

  <div id="workspace">
    <aside id="sidebar">
      <div class="sidebar-section">
        <div class="control-group">
          <label>Status</label>
          <select id="status-select" class="input-std">
            <option value="ongoing">üî¥ Ongoing</option>
            <option value="pending">üü° Pending</option>
            <option value="done">üü¢ Done</option>
          </select>
        </div>
        <div id="dynamic-inputs"></div>
      </div>
      <div class="sidebar-footer">
        <button class="btn" id="btn-clear">üßπ Clear</button>
        <button class="btn" id="btn-load" onclick="document.getElementById('jsonUpload').click()">üìÇ Load</button>
        <button class="btn" id="btn-backup">üíæ Backup</button>
        <button class="btn primary" id="btn-save">üìÑ Save Log</button>
      </div>
    </aside>

    <main id="content-area">
      <div id="welcome-msg" style="text-align:center; margin-top:50px; color:var(--text-main); opacity:0.6;">
        <h3>NO CONFIGURATION LOADED</h3>
        <p>Drag & Drop a JSON file here.</p>
      </div>
      <div id="snippets-grid"></div>
    </main>

    <div id="notes-drawer">
      <div class="drawer-header" id="drawer-handle">
        <span id="note-header-text">üìù Notes</span>
        <div class="drawer-controls">
          <span onclick="resizeDrawer('minimized')">_</span>
          <span onclick="resizeDrawer('normal')">‚òê</span>
          <span onclick="resizeDrawer('maximized')">üóñ</span>
        </div>
      </div>
      <textarea id="note-input" placeholder="..."></textarea>
    </div>
  </div>

  <input type="file" id="jsonUpload" accept=".json" />

<script>
  // --- STATE ---
  const hostHash = Math.random().toString(36).substring(2, 8).toUpperCase();
  let sessions = []; 
  let activeSessionId = null;
  let snippetConfig = {}; 
  let filters = {};
  let hiddenFields = {};
  let currentLang = "en"; // Default
  let defaultLangFallback = "en";

  const LS_CONFIG = "support_ide_config";
  const LS_SESSIONS = "support_ide_sessions";
  const LS_ACTIVE = "support_ide_active";

  // --- INIT ---
  window.addEventListener('load', () => {
    // 1. Config
    const savedConfig = localStorage.getItem(LS_CONFIG);
    if(savedConfig) {
      try {
        const json = JSON.parse(savedConfig);
        loadConfigInternal(json, false);
      } catch(e) { console.error("Config corrupt", e); }
    }

    // 2. Sessions
    const savedSessions = localStorage.getItem(LS_SESSIONS);
    const savedActive = localStorage.getItem(LS_ACTIVE);
    
    if(savedSessions && JSON.parse(savedSessions).length > 0) {
      sessions = JSON.parse(savedSessions);
      activeSessionId = savedActive ? parseInt(savedActive) : sessions[0].id;
      if(!sessions.find(s => s.id === activeSessionId)) activeSessionId = sessions[0].id;
      renderTabs();
      switchTab(activeSessionId);
    } else {
      createNewSession(true);
    }
  });

  setInterval(() => {
    if(activeSessionId) saveCurrentStateToMemory(); 
    localStorage.setItem(LS_SESSIONS, JSON.stringify(sessions));
    localStorage.setItem(LS_ACTIVE, activeSessionId);
  }, 2000);

  // --- LANGUAGE ENGINE ---
  function initLanguageSelector(config) {
    const select = document.getElementById("lang-select");
    select.innerHTML = ""; 

    let langs = ["en"];
    if(config.config) {
        if(config.config.supportedLangs) langs = config.config.supportedLangs;
        if(config.config.defaultLang) {
            defaultLangFallback = config.config.defaultLang;
            // Only set current if not already set by previous load or user action (if persistence desired)
            if(!currentLang) currentLang = defaultLangFallback;
        }
    }
    // ensure currentLang is valid
    if(!langs.includes(currentLang)) currentLang = defaultLangFallback;

    langs.forEach(code => {
        const opt = document.createElement("option");
        opt.value = code;
        opt.innerText = code.toUpperCase();
        select.appendChild(opt);
    });

    select.value = currentLang;
    
    select.addEventListener("change", (e) => {
        currentLang = e.target.value;
        refreshUI();
    });
  }

  // Fallback Logic: Specific Lang -> Default Lang -> First Avail -> Raw String
  function getLocalizedText(obj) {
    if (typeof obj === 'string') return obj; // Not translated
    if (!obj) return "";
    
    if(obj[currentLang]) return obj[currentLang];
    if(obj[defaultLangFallback]) return obj[defaultLangFallback];
    
    const keys = Object.keys(obj);
    if(keys.length > 0) return obj[keys[0]];
    return "";
  }
  
  // New helper: Translates Keys (Headers/Titles) using Dictionary
  function translateKey(key) {
    if(snippetConfig.dictionary && snippetConfig.dictionary[key]) {
        return getLocalizedText(snippetConfig.dictionary[key]);
    }
    return key;
  }

  function refreshUI() {
    if(snippetConfig.dictionary) applyUILabels(snippetConfig.dictionary);
    renderSnippets(); // Updates content AND headers
    const session = sessions.find(s => s.id === activeSessionId);
    if(session) updateNoteHeader(session.title);
  }

  function applyTheme(theme) {
    const root = document.documentElement;
    if(theme.nav) root.style.setProperty('--bg-nav', theme.nav);
    if(theme.sidebar) root.style.setProperty('--bg-sidebar', theme.sidebar);
    if(theme.content) root.style.setProperty('--bg-content', theme.content);
    if(theme.notes) root.style.setProperty('--bg-notes', theme.notes);
    if(theme.accent) root.style.setProperty('--accent', theme.accent);
    if(theme.textMain) root.style.setProperty('--text-main', theme.textMain);
    if(theme.textHeader) root.style.setProperty('--text-header', theme.textHeader);
  }

  function applyUILabels(dict) {
    if(!dict) return;
    const map = {
        "btn-load": dict.btnLoad, "btn-backup": dict.btnBackup, "btn-save": dict.btnSave, "btn-clear": dict.btnClear,
        "search-box": dict.searchPlaceholder, "note-input": dict.notesPlaceholder 
    };

    Object.keys(map).forEach(id => {
        const el = document.getElementById(id);
        const text = getLocalizedText(map[id]);
        if(el && text) {
            if(el.tagName === "INPUT" || el.tagName === "TEXTAREA") el.placeholder = text;
            else el.innerText = text;
        }
    });
    
    if(dict.statusOngoing) document.querySelector("option[value='ongoing']").innerText = getLocalizedText(dict.statusOngoing);
    if(dict.statusPending) document.querySelector("option[value='pending']").innerText = getLocalizedText(dict.statusPending);
    if(dict.statusDone) document.querySelector("option[value='done']").innerText = getLocalizedText(dict.statusDone);
  }

  // --- GENERAL UI ---
  function toggleAbout() { document.getElementById("about-overlay").classList.toggle("open"); }
  document.getElementById("about-overlay").addEventListener("click", (e) => { if(e.target.id === "about-overlay") toggleAbout(); });

  function showToast(msg) {
    const el = document.getElementById("notification-toast");
    el.textContent = msg; el.classList.add("show");
    setTimeout(() => el.classList.remove("show"), 2000);
  }

  // --- TABS ---
  function createNewSession(useDefaults = false) {
    const id = Date.now();
    const newSession = { id: id, title: `Ticket ${sessions.length + 1}`, status: 'ongoing', data: {}, note: "" };
    
    if(snippetConfig.fields) {
      Object.keys(snippetConfig.fields).forEach(k => {
          if (useDefaults || (hiddenFields && hiddenFields[k])) {
             newSession.data[k] = snippetConfig.fields[k];
          } else {
             newSession.data[k] = ""; 
          }
      });
    }
    sessions.push(newSession);
    switchTab(id);
    renderTabs();
  }

  function switchTab(id) {
    if (activeSessionId) saveCurrentStateToMemory();
    activeSessionId = id;
    const session = sessions.find(s => s.id === id);
    if(!session) return; 

    // Restore UI Inputs
    const inputsContainer = document.getElementById("dynamic-inputs");
    const inputs = inputsContainer.querySelectorAll("input");
    
    if(inputs.length > 0 && snippetConfig.fields) {
        inputs.forEach(input => {
          const key = input.getAttribute("data-key");
          input.value = session.data[key] !== undefined ? session.data[key] : "";
        });
    } else if (snippetConfig.fields) {
        renderSidebarInputs(snippetConfig.fields);
    }

    document.getElementById("note-input").value = session.note || "";
    document.getElementById("status-select").value = session.status;
    updateNoteHeader(session.title);
    renderTabs();
    refreshUI(); 
  }

  function saveCurrentStateToMemory() {
    const session = sessions.find(s => s.id === activeSessionId);
    if (!session) return;
    const inputs = document.querySelectorAll("#dynamic-inputs input");
    inputs.forEach(input => session.data[input.getAttribute("data-key")] = input.value);
    session.note = document.getElementById("note-input").value;
    session.status = document.getElementById("status-select").value;
  }

  function closeTab(e, id) {
    e.stopPropagation();
    if (sessions.length === 1) return alert("Cannot close last tab");
    const index = sessions.findIndex(s => s.id === id);
    sessions.splice(index, 1);
    if (id === activeSessionId) switchTab(sessions[Math.max(0, index - 1)].id);
    else renderTabs();
  }

  function renderTabs() {
    const container = document.getElementById("tabs-container");
    container.innerHTML = "";
    sessions.forEach((s, index) => {
      s.title = `Ticket ${index + 1}`; 
      const el = document.createElement("div");
      el.className = `tab status-${s.status} ${s.id === activeSessionId ? 'active' : ''}`;
      el.onclick = () => switchTab(s.id);
      el.innerHTML = `<div class="tab-status-dot"></div><span>${s.title}</span><span class="tab-close" onclick="closeTab(event, ${s.id})">√ó</span>`;
      container.appendChild(el);
    });
  }
  document.getElementById("new-tab-btn").addEventListener("click", () => createNewSession(false));

  // --- ACTIONS ---
  document.getElementById("btn-clear").addEventListener("click", () => {
    if(!confirm("Clear fields?")) return;
    const session = sessions.find(s => s.id === activeSessionId);
    if(!session) return;
    Object.keys(session.data).forEach(k => { if(!hiddenFields[k]) session.data[k] = ""; });
    const inputs = document.querySelectorAll("#dynamic-inputs input");
    inputs.forEach(input => input.value = "");
    renderSnippets(); showToast("Cleared");
  });

  document.getElementById("status-select").addEventListener("change", (e) => {
    const session = sessions.find(s => s.id === activeSessionId);
    if(session) { session.status = e.target.value; renderTabs(); }
  });
  document.getElementById("note-input").addEventListener("input", (e) => {
    const session = sessions.find(s => s.id === activeSessionId);
    if(session) session.note = e.target.value;
  });

  function updateNoteHeader(title) {
    let headerText = "üìù Notes";
    if(snippetConfig.dictionary && snippetConfig.dictionary.notesHeader) {
        headerText = getLocalizedText(snippetConfig.dictionary.notesHeader);
    }
    document.getElementById("note-header-text").innerText = `${headerText} - ${title}`;
  }

  document.getElementById("search-box").addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll(".card").forEach(card => {
      card.style.display = card.textContent.toLowerCase().includes(term) ? "block" : "none";
    });
  });

  // --- FILE HANDLING ---
  function loadConfigInternal(json, hardReset = true) {
    if(hardReset) activeSessionId = null; 

    snippetConfig = json;
    hiddenFields = json.hidden || {};
    filters = json.filters || {};
    
    initLanguageSelector(json);

    if(json.theme) applyTheme(json.theme);
    localStorage.setItem(LS_CONFIG, JSON.stringify(json));
    document.getElementById("welcome-msg").style.display = "none";
    
    renderSidebarInputs(json.fields);

    if(hardReset) {
      sessions = [];
      createNewSession(true); 
    } else {
        if(activeSessionId) switchTab(activeSessionId);
    }
    refreshUI(); 
  }

  function readJsonFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const json = JSON.parse(e.target.result);
        if(json.appType === "workspace_backup") {
          if(confirm("Restore Backup?")) {
             activeSessionId = null; 
             loadConfigInternal(json.config, false); 
             sessions = json.sessions;
             switchTab(json.activeId);
             showToast("Backup Restored");
          }
        } else {
           if(confirm("Load Config? (Clears Tickets)")) {
             loadConfigInternal(json, true); 
             showToast("Config Loaded");
           }
        }
      } catch(err) { alert("Invalid JSON"); }
    };
    reader.readAsText(file);
  }

  function renderSidebarInputs(fields) {
    const container = document.getElementById("dynamic-inputs");
    container.innerHTML = "";
    if(!fields) return;
    let session = sessions.find(s => s.id === activeSessionId);

    Object.entries(fields).forEach(([key, defaultVal]) => {
      if(hiddenFields && hiddenFields[key]) return;
      
      const group = document.createElement("div");
      group.className = "control-group";
      const label = document.createElement("label");
      label.textContent = key;
      const input = document.createElement("input");
      input.type = "text"; input.className = "input-std";
      input.setAttribute("data-key", key);
      
      let valueToSet = defaultVal;
      if (session) {
          if (session.data[key] === undefined) session.data[key] = "";
          valueToSet = session.data[key];
      } else { valueToSet = defaultVal; }
      
      input.value = valueToSet;

      input.addEventListener("input", (e) => {
        let val = e.target.value;
        if(filters[key] && filters[key].regex) {
          try { const m = val.match(new RegExp(filters[key].regex)); val = m ? m[0] : val; } catch(err){}
        }
        const currentSess = sessions.find(s => s.id === activeSessionId);
        if(currentSess) currentSess.data[key] = val;
        renderSnippets();
      });
      group.appendChild(label); group.appendChild(input); container.appendChild(group);
    });
  }

  function renderSnippets() {
    const container = document.getElementById("snippets-grid");
    container.innerHTML = "";
    if(!snippetConfig || !snippetConfig.fields) return;

    const session = sessions.find(s => s.id === activeSessionId);
    const safeData = session ? session.data : {};
    
    // Reserved Keys
    const ignore = ["fields", "logo", "note", "hidden", "filters", "googleSheetFields", "theme", "ui", "dictionary", "config"];

    Object.entries(snippetConfig).forEach(([catKey, content]) => {
      if(ignore.includes(catKey)) return;
      
      // TRANSLATE CATEGORY HEADER
      const headerText = translateKey(catKey);

      const header = document.createElement("div");
      header.className = "category-header"; header.textContent = headerText; container.appendChild(header);
      const grid = document.createElement("div"); grid.className = "grid";

      Object.entries(content).forEach(([labelKey, value]) => {
        if(["tags", "shortcuts"].includes(labelKey)) return;
        
        // TRANSLATE CARD TITLE
        const labelText = translateKey(labelKey);

        // GET LOCALIZED CONTENT
        let text = getLocalizedText(value);

        const card = document.createElement("div"); card.className = "card";
        
        const displayHtml = text.replace(/\[([^\]]+)\]/g, (_, k) => {
          const val = safeData[k] || (hiddenFields && hiddenFields[k]) || `[${k}]`;
          return `<span class="highlight-var">${val}</span>`;
        });
        const rawText = text.replace(/\[([^\]]+)\]/g, (_, k) => {
          return safeData[k] || (hiddenFields && hiddenFields[k]) || `[${k}]`;
        });
        
        card.innerHTML = `<strong>${labelText}</strong>${displayHtml}`;
        card.onclick = () => {
          navigator.clipboard.writeText(rawText);
          showToast("üìã Copied!");
        };
        grid.appendChild(card);
      });
      container.appendChild(grid);
    });
    const searchVal = document.getElementById("search-box").value;
    if(searchVal) document.getElementById("search-box").dispatchEvent(new Event('input'));
  }

  // --- ACTIONS ---
  document.getElementById("btn-backup").addEventListener("click", () => {
    saveCurrentStateToMemory();
    const backup = { appType: "workspace_backup", timestamp: new Date().toISOString(), config: snippetConfig, sessions: sessions, activeId: activeSessionId };
    downloadFile(`backup-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(backup));
  });

  document.getElementById("btn-save").addEventListener("click", () => {
    const session = sessions.find(s => s.id === activeSessionId);
    if(!session) return;
    const now = new Date();
    const filename = `${now.toISOString().split('T')[0]}-${hostHash}.txt`;
    let content = `LOG ID: ${hostHash}\nDATE: ${now.toLocaleString()}\nSTATUS: ${session.status.toUpperCase()}\n----------------\n`;
    Object.entries(session.data).forEach(([k, v]) => { if(v) content += `${k}: ${v}\n`; });
    content += `----------------\nNOTES:\n${session.note}\n`;
    downloadFile(filename, content); showToast("Log Saved");
  });

  function downloadFile(name, content) {
    const blob = new Blob([content], {type: "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  document.body.addEventListener("dragover", e => e.preventDefault());
  document.body.addEventListener("drop", e => { e.preventDefault(); if(e.dataTransfer.files[0]) readJsonFile(e.dataTransfer.files[0]); });
  document.getElementById("jsonUpload").addEventListener("change", (e) => { if(e.target.files[0]) readJsonFile(e.target.files[0]); });

  function resizeDrawer(state) {
    const drawer = document.getElementById("notes-drawer");
    drawer.className = state;
    const content = document.getElementById("content-area");
    if(state === 'maximized') content.style.display = 'none';
    else { content.style.display = 'block'; content.style.paddingBottom = (state === 'normal' ? 160 : 40) + "px"; }
  }
  document.getElementById("drawer-handle").addEventListener("dblclick", () => {
    const d = document.getElementById("notes-drawer");
    resizeDrawer(d.classList.contains("minimized") ? "normal" : "minimized");
  });
</script>
</body>
</html>